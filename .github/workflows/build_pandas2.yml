name: Build Pandas 3.0.0 ARM32 2

on:
  workflow_dispatch: # 手动触发

jobs:
  build_wheels:
    name: Build pandas-3.0.0 for armv7l
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 下载 Pandas 3.0.0 源码包 (sdist)
# 修改后的步骤：使用 curl 直接下载，绕过 pip 的元数据构建过程
      - name: Download Pandas 3.0.0 Source Directly
        run: |
          # 从 PyPI 直接获取源码包地址
          curl -L https://files.pythonhosted.org/packages/source/p/pandas/pandas-3.0.0.tar.gz -o pandas-3.0.0.tar.gz
          tar -xzf pandas-3.0.0.tar.gz
          # 将源码移动到当前工作目录
          cp -r pandas-3.0.0/* .
          # 清理一下，节省空间
          rm pandas-3.0.0.tar.gz

# 2. 配置 QEMU
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      # 3. 编译（增加了引号和显式的 Build 目标）
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: armv7l
          CIBW_MANYLINUX_ARMV7L_IMAGE: manylinux2014
          # 必须加引号，否则 YAML 解析会出错
          CIBW_TEST_SKIP: "*"
          # 明确指定要编译的 Python 版本（例如 3.10, 3.11, 3.12）
          # 这能防止 cibuildwheel 尝试编译它认为“应该”编译的所有版本
          CIBW_BUILD: "cp310-manylinux_armv7l cp311-manylinux_armv7l cp312-manylinux_armv7l"
          
          CIBW_ENVIRONMENT: >
            MAKEFLAGS="-j2" 
            NINJAFLAGS="-j2"

      # 4. 上传二进制文件
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pandas-3.0.0-armv7l-wheels
          path: ./wheelhouse/*.whl
