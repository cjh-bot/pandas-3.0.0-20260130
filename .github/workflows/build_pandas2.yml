name: Build Pandas 3.0.0 ARM32

on:
  workflow_dispatch: 

jobs:
  build_wheels:
    name: Build pandas-3.0.0 for armv7l
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 下载源码并彻底禁用官方 cibuildwheel 配置
      - name: Download and Prepare Source
        run: |
          curl -L https://files.pythonhosted.org/packages/source/p/pandas/pandas-3.0.0.tar.gz -o pandas-3.0.0.tar.gz
          tar -xzf pandas-3.0.0.tar.gz
          cp -r pandas-3.0.0/* .
          
          # 使用 Python 脚本安全地重命名 pyproject.toml 里的 tool.cibuildwheel 段落
          # 这样可以完全无视官方的 skip/build 规则，改用我们环境变量定义的规则
          python3 -c "
          import os
          content = open('pyproject.toml').read()
          new_content = content.replace('[tool.cibuildwheel]', '[tool.cibuildwheel_disabled]')
          with open('pyproject.toml', 'w') as f:
              f.write(new_content)
          "
          
          rm pandas-3.0.0.tar.gz
          rm -rf pandas-3.0.0

      # 2. 配置 QEMU
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      # 3. 编译
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        env:
          # 强制指定架构
          CIBW_ARCHS_LINUX: armv7l
          
          # 手动指定完整的镜像路径，防止 cibuildwheel 找不到 armv7l 镜像
          CIBW_MANYLINUX_ARMV7L_IMAGE: quay.io/pypa/manylinux2014_armv7l
          
          # 明确指定版本，Pandas 3.0 只支持 Python 3.11+
          CIBW_BUILD: "cp311-manylinux_armv7l cp312-manylinux_armv7l"
          
          # 强制不跳过任何内容
          CIBW_SKIP: ""
          CIBW_TEST_SKIP: "*"
          
          # 内存保护
          CIBW_ENVIRONMENT: >
            MAKEFLAGS="-j2" 
            NINJAFLAGS="-j2"

      # 4. 上传
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pandas-3.0.0-armv7l-wheels
          path: ./wheelhouse/*.whl
