name: Build Pandas 3.0.0 ARM32

on:
  workflow_dispatch: 

jobs:
  build_wheels:
    name: Build pandas-3.0.0 for armv7l
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # 1. 下载 Pandas 3.0.0 源码并暴力清理官方干扰配置
      - name: Download and Clean Source
        run: |
          # 直接下载源码包
          curl -L https://files.pythonhosted.org/packages/source/p/pandas/pandas-3.0.0.tar.gz -o pandas-3.0.0.tar.gz
          tar -xzf pandas-3.0.0.tar.gz
          cp -r pandas-3.0.0/* .
          
          # 【极其重要】删除源码里自带的 cibuildwheel 配置块
          # 因为官方配置里写死了特定的 Python 版本和过滤条件，会和 ARM32 冲突
          sed -i '/\[tool.cibuildwheel\]/,$d' pyproject.toml
          
          # 验证一下文件是否修改成功（可选）
          tail -n 5 pyproject.toml
          rm pandas-3.0.0.tar.gz

      # 2. 配置 QEMU (ARM 模拟器)
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm

      # 3. 使用 cibuildwheel 编译
      - name: Build wheels
        uses: pypa/cibuildwheel@v2.21.3
        env:
          CIBW_ARCHS_LINUX: armv7l
          # 针对 Ubuntu 18.04 (glibc 2.27)，必须使用 manylinux2014
          CIBW_MANYLINUX_ARMV7L_IMAGE: manylinux2014
          
          # 【修正】Pandas 3.0+ 不支持 Python 3.10，必须从 3.11 开始
          CIBW_BUILD: "cp311-manylinux_armv7l cp312-manylinux_armv7l"
          
          CIBW_TEST_SKIP: "*"
          
          # 内存保护：ARM 模拟器下编译大型 C++ 极其吃内存，限制并行数
          CIBW_ENVIRONMENT: >
            MAKEFLAGS="-j2" 
            NINJAFLAGS="-j2"

      # 4. 上传结果
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pandas-3.0.0-armv7l-wheels
          path: ./wheelhouse/*.whl
